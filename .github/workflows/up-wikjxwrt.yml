name: Sync r4s_build_script

permissions:
  contents: write  # å…è®¸å†™å…¥å†…å®¹

on:
  push:
    paths:
      - '.github/workflows/sync.yml'  # ç›‘å¬è¯¥æ–‡ä»¶çš„æ›´æ”¹
  schedule:
    - cron: '0 */12 * * *'  # æ¯12å°æ—¶è¿è¡Œä¸€æ¬¡
  workflow_dispatch:  # æ”¯æŒæ‰‹åŠ¨è§¦å‘

jobs:
  sync:
    runs-on: ubuntu-latest
    steps:
      # 1. å…‹éš†ç›®æ ‡ä»“åº“ sbwml/r4s_build_script
      - name: Clone r4s_build_script Repository
        run: |
          git clone https://github.com/sbwml/r4s_build_script.git r4s_build_script
          cd r4s_build_script
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      # 2. å…‹éš†ä½ çš„ä»“åº“ wixxm/wikjxwrt-6.12
      - name: Clone Your Repository
        env:
          PAT: ${{ secrets.GH_PAT }}
        run: |
          git clone https://x-access-token:${PAT}@github.com/wixxm/wikjxwrt-6.12.git target_repo

      # 3. å¤‡ä»½ .githubã€scripts æ–‡ä»¶å¤¹å’Œéœ€è¦ä¿ç•™çš„æ–‡ä»¶
      - name: Backup Existing Files
        run: |
          mkdir -p backup
          # å¤‡ä»½ .github æ–‡ä»¶å¤¹
          if [ -d "target_repo/.github" ]; then
            mv target_repo/.github backup/github_backup
          fi
          # å¤‡ä»½ scripts æ–‡ä»¶å¤¹
          if [ -d "target_repo/scripts" ]; then
            mv target_repo/scripts backup/scripts_backup
          fi
          # å¤‡ä»½éœ€è¦ä¿ç•™çš„ç‰¹å®šæ–‡ä»¶
          mkdir -p backup/files
          cp -r target_repo/openwrt/24-config-musl-x86 backup/files/
          cp -r target_repo/openwrt/24-config-common backup/files/
          cp -r target_repo/openwrt/build.sh backup/files/

      # 4. å°† r4s_build_script ä»“åº“çš„å†…å®¹åŒæ­¥åˆ°ä½ çš„ä»“åº“
      - name: Sync r4s_build_script Changes to Your Repo
        run: |
          rsync -av --delete --exclude='.git' --exclude='.github' --exclude='scripts' --exclude='openwrt/24-config-musl-x86' --exclude='openwrt/24-config-common' --exclude='openwrt/build.sh' r4s_build_script/ target_repo/

      # 5. æ¢å¤å¤‡ä»½çš„æ–‡ä»¶å’Œæ–‡ä»¶å¤¹
      - name: Restore Backup Files
        run: |
          # æ¢å¤ .github æ–‡ä»¶å¤¹
          if [ -d "backup/github_backup" ]; then
            mv backup/github_backup target_repo/.github
          fi
          # æ¢å¤ scripts æ–‡ä»¶å¤¹
          if [ -d "backup/scripts_backup" ]; then
            mv backup/scripts_backup target_repo/scripts
          fi
          # æ¢å¤å…¶ä»–æ–‡ä»¶
          cp -r backup/files/24-config-musl-x86 target_repo/openwrt/
          cp -r backup/files/24-config-common target_repo/openwrt/
          cp -r backup/files/build.sh target_repo/openwrt/

      # 6. é…ç½® Git ç”¨æˆ·ä¿¡æ¯å¹¶æäº¤æ›´æ”¹
      - name: Commit and Push Changes
        env:
          PAT: ${{ secrets.GH_PAT }}
        run: |
          cd target_repo
          git config user.name "wixxm"  # ä¿®æ”¹ä¸ºä½ çš„ç”¨æˆ·å
          git config user.email "your_email@github.com"  # ä¿®æ”¹ä¸ºä½ çš„é‚®ç®±

          # è®¾ç½®æ—¶åŒºä¸ºä¸Šæµ·
          export TZ="Asia/Shanghai"

          # è·å–å½“å‰æ—¥æœŸå’Œæ—¶é—´
          timestamp=$(date +"%Y-%m-%d %H:%M:%S")

          # æäº¤å¹¶å¼ºåˆ¶æ¨é€æ›´æ”¹
          git add .
          git commit -m "ğŸš€ Sync r4s_build_script - $timestamp" || echo "æ²¡æœ‰æ–°çš„æ›´æ”¹å¯æäº¤"
          git push origin HEAD:main --force
